#!/bin/bash

DIR=$(dirname "$(readlink -f $0)")

if PID=`/usr/bin/python $DIR/server.py getpid`; then
    echo "Server already running (pid $PID)"
    exit
fi

if ! ulimit -n 65536; then
    echo "Warning: Could not set ulimit."
    echo "You might need to allow it in /etc/security/limits.conf (see HOWTO)"
fi

if [ "$(id -u)" == "0" ]; then
   echo "Warning: you are running electrum server as root. Consider using a non privileged user." 1>&2
   exit 1
fi


electrum_config="/etc/electrum.conf"

if [ ! -f $electrum_config ]; then
    echo "$electrum_config does not exist"
    exit
fi

# read path from config
path=`grep -e ^path $electrum_config |awk -F\= '{print $2}' | tail -n 1| tr -d ' '`
if ! [ "$path" ]; then
    echo "Variable path not set in $electrum_config"
    exit
fi

if [ -f $path/electrum.log ]; then
    mv $path/electrum.log $path/electrum.log.1
fi

echo "Starting server as daemon"
nohup /usr/bin/python -u $DIR/server.py &> $path/electrum.log &
